import React, { useState, useEffect, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import Layout from '../components/layout/Layout';
import { Button } from '../components/ui/button';
import MasonryGrid from '../components/layout/MasonryGrid';
import Breadcrumb, { BreadcrumbItem } from '../components/common/Breadcrumb';
import { ImageService, HomeImage, Tag } from '../services/imageService';
import { CategoriesService, Category } from '../services/categoriesService';
import { downloadImageByUrl, downloadImageAsPdf } from '../utils/downloadUtils';
import { useLanguage } from '../contexts/LanguageContext';
import { getLocalizedText } from '../utils/textUtils';
import { useAsyncTranslation } from '../contexts/LanguageContext';
import { useCategories } from '../contexts/CategoriesContext';
import { getImageIdByName, isImageName, updateImageMappings, getImageNameById, getEnglishTitleFromImage } from '../utils/imageUtils';
import { getCategoryIdByName, getCategoryNameById, isCategoryName, getEnglishNameFromCategory, updateCategoryMappings } from '../utils/categoryUtils';
import { navigateWithLanguage } from '../utils/navigationUtils';
import SEOHead from '../components/common/SEOHead';
const downloadIcon = '/images/download-white.svg';

const ImageDetailPage: React.FC = () => {
  const { t } = useAsyncTranslation('categories');
  const { imageId, categoryId } = useParams<{ imageId: string; categoryId?: string }>();
  const navigate = useNavigate();
  const { language } = useLanguage();
  const { categories: allCategories, loading: categoriesLoading } = useCategories();
  
  const [image, setImage] = useState<HomeImage | null>(null);
  const [category, setCategory] = useState<Category | null>(null);
  const [relatedImages, setRelatedImages] = useState<HomeImage[]>([]);
  const [isImageLoading, setIsImageLoading] = useState(true);
  const [isRelatedImagesLoading, setIsRelatedImagesLoading] = useState(true);
  const [isDownloading, setIsDownloading] = useState<{ png: boolean; pdf: boolean }>({
    png: false,
    pdf: false
  });
  
  const leftImagesRef = useRef<HTMLDivElement>(null);
  const loadingRef = useRef<string>(''); // Èò≤Ê≠¢ÈáçÂ§çÂä†ËΩΩ


  // Ëß£Êûê additionalInfoÔºåÁõ¥Êé•‰ªéÂ§öËØ≠Ë®ÄÂØπË±°‰∏≠Ëé∑ÂèñÊú¨Âú∞ÂåñÊñáÊú¨
  const parseAdditionalInfo = (additionalInfo: any) => {
    try {
      let infoObj = additionalInfo;
      
      // Â¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂ∞ùËØïËß£Êûê JSON
      if (typeof additionalInfo === 'string' && additionalInfo.trim()) {
        infoObj = JSON.parse(additionalInfo);
      }
      
      // Â¶ÇÊûú‰∏çÊòØÂØπË±°ÔºåËøîÂõû null
      if (typeof infoObj !== 'object' || infoObj === null) {
        return null;
      }
      
      // Áõ¥Êé•‰ªéÂ§öËØ≠Ë®ÄÂØπË±°‰∏≠Ëé∑ÂèñÊú¨Âú∞ÂåñÊñáÊú¨Âπ∂ËøîÂõû
      return getLocalizedText(infoObj, language);
    } catch (error) {
      console.error('Failed to parse additionalInfo:', error, additionalInfo);
      return null;
    }
  };

  useEffect(() => {
    const loadImageData = async () => {
      if (!imageId) return;

      // Èò≤Ê≠¢ÈáçÂ§çÂä†ËΩΩÔºöÂ¶ÇÊûúÂ∑≤Áªè‰∏∫ÂΩìÂâçimageIdÂíåcategoryIdÁªÑÂêàÊ≠£Âú®Âä†ËΩΩÔºåÂàôË∑≥Ëøá
      const currentKey = `${imageId}-${categoryId || 'no-category'}`;
      if (loadingRef.current === currentKey) {
        console.log('Already loading for', currentKey, 'skipping...');
        return;
      }

      // ËÆæÁΩÆÂΩìÂâçÂä†ËΩΩÁöÑkey
      loadingRef.current = currentKey;

      try {
        setIsImageLoading(true);
        
        // Â¶ÇÊûúURL‰∏≠ÊúâcategoryIdÔºå‰ΩøÁî®‰ºòÂåñÁöÑÂä†ËΩΩÈÄªËæë
        if (categoryId) {
          // Ê≠•È™§1Ôºö‰ΩøÁî®categories contextËé∑ÂèñÂÖ®ÈáèÂàÜÁ±ªÊï∞ÊçÆ
          if (categoriesLoading || !allCategories || allCategories.length === 0) {
            console.log('Categories still loading, waiting...');
            setIsImageLoading(false);
            return;
          }
          
          // Ê≠•È™§2ÔºöÊ†πÊçÆURL‰∏≠ÁöÑÂàÜÁ±ªÂêçÁß∞ÊâæÂà∞ÂàÜÁ±ªID
          let foundCategory: Category | null = null;
          
          // ÂÖàÂ∞ùËØïÊò†Â∞ÑË°®
          if (isCategoryName(categoryId)) {
            const actualCategoryId = getCategoryIdByName(categoryId);
            foundCategory = allCategories.find(cat => cat.categoryId === actualCategoryId) || null;
          }
          
          // Â¶ÇÊûúÊò†Â∞ÑË°®Ê≤°ÊâæÂà∞ÔºåÈÄöËøáSEOÂêçÁß∞ÊêúÁ¥¢
          if (!foundCategory) {
            foundCategory = allCategories.find((cat: Category) => {
              const seoName = getEnglishNameFromCategory(cat.displayName);
              return seoName === categoryId;
            }) || null;
            
            if (foundCategory) {
              // Êõ¥Êñ∞Êò†Â∞ÑË°®
              updateCategoryMappings([foundCategory]);
            }
          }
          
          if (foundCategory) {
            setCategory(foundCategory);
            
            // Ê≠•È™§3ÔºöÊ†πÊçÆÂàÜÁ±ªID‰ªéÂêéÂè∞Ëé∑ÂèñËØ•ÂàÜÁ±ªÁöÑÊâÄÊúâÂõæÁâá
            const categoryImagesResult = await CategoriesService.getImagesByCategoryId(foundCategory.categoryId);
            
            // Êõ¥Êñ∞ÂõæÁâáÊò†Â∞ÑË°®
            updateImageMappings(categoryImagesResult.images);
            
            // Ê≠•È™§4ÔºöÊ†πÊçÆURL‰∏≠ÁöÑÂõæÁâáÂêçÁß∞ËøáÊª§Âá∫ÈúÄË¶ÅÁöÑÂõæÁâá
            let foundImage: HomeImage | null = null;
            
            // ÂÖàÂ∞ùËØïÊò†Â∞ÑË°®
            if (isImageName(imageId)) {
              const actualImageId = getImageIdByName(imageId);
              foundImage = categoryImagesResult.images.find((img: HomeImage) => img.id === actualImageId) || null;
            }
            
            // Â¶ÇÊûúÊò†Â∞ÑË°®Ê≤°ÊâæÂà∞ÔºåÈÄöËøáSEOÂêçÁß∞ÊêúÁ¥¢
            if (!foundImage) {
              foundImage = categoryImagesResult.images.find((img: HomeImage) => {
                const seoName = getEnglishTitleFromImage(img.title);
                return seoName === imageId;
              }) || null;
              
              if (foundImage) {
                // Êõ¥Êñ∞Êò†Â∞ÑË°®
                updateImageMappings([foundImage]);
              }
            }
            
            if (foundImage) {
              setImage(foundImage);
              setIsImageLoading(false);
              
              // ÂºÇÊ≠•Âä†ËΩΩÁõ∏ÂÖ≥ÂõæÁâáÔºå‰∏çÈòªÂ°û‰∏ªÂÜÖÂÆπÊòæÁ§∫
              setIsRelatedImagesLoading(true);
              try {
                const relatedImages = await ImageService.getRelatedImages(foundImage.categoryId, foundImage.id);
                setRelatedImages(relatedImages);
                
                // Êõ¥Êñ∞Áõ∏ÂÖ≥ÂõæÁâáÁöÑÊò†Â∞ÑË°®
                updateImageMappings(relatedImages);
              } catch (error) {
                console.error('Failed to load related images:', error);
              } finally {
                setIsRelatedImagesLoading(false);
              }
            } else {
              console.error('‚ùå Image not found in category:', imageId);
              setIsImageLoading(false);
            }
          } else {
            console.error('‚ùå Category not found:', categoryId);
            setIsImageLoading(false);
          }
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâcategoryIdÔºå‰ΩøÁî®ÂéüÊù•ÁöÑÈÄªËæëÔºàÂêëÂêéÂÖºÂÆπÔºâ
          console.log('üîç Loading image without category context:', imageId);
          
          // Â∞ùËØï‰ΩøÁî®Êò†Â∞ÑË°®ËΩ¨Êç¢SEOÂèãÂ•ΩÂêçÁß∞
          let actualImageId: string;
          if (isImageName(imageId)) {
            actualImageId = getImageIdByName(imageId);
          } else {
            actualImageId = imageId;
          }
          
          // ÈÄöËøáAPIÊêúÁ¥¢ÂõæÁâá
          let foundImage: HomeImage | null = await ImageService.getImageById(actualImageId);
          
          if (!foundImage && imageId !== actualImageId) {
            // Â¶ÇÊûúÈÄöËøáÊò†Â∞ÑË°®ËΩ¨Êç¢ÁöÑIDÊ≤°ÊâæÂà∞ÂõæÁâáÔºåÂ∞ùËØïÈÄöËøáSEOÂêçÁß∞ÊêúÁ¥¢
            console.log('Image not found by ID, trying to search by SEO name:', imageId);
            try {
              const searchResult = await ImageService.searchImages({ query: imageId, pageSize: 50 });
              
              foundImage = searchResult.images.find(img => {
                const seoName = getEnglishTitleFromImage(img.title);
                return seoName === imageId;
              }) || null;
              
              if (foundImage) {
                console.log('Found image by SEO name search:', foundImage.id);
                updateImageMappings([foundImage]);
              }
            } catch (searchError) {
              console.error('Failed to search image by SEO name:', searchError);
            }
          }

          if (foundImage) {
            setImage(foundImage);
            setIsImageLoading(false);
            
            // ÂºÇÊ≠•Âä†ËΩΩÁõ∏ÂÖ≥ÂõæÁâá
            setIsRelatedImagesLoading(true);
            try {
              const relatedImages = await ImageService.getRelatedImages(foundImage.categoryId, foundImage.id);
              setRelatedImages(relatedImages);
              updateImageMappings(relatedImages);
            } catch (error) {
              console.error('Failed to load related images:', error);
            } finally {
              setIsRelatedImagesLoading(false);
            }
          } else {
            setIsImageLoading(false);
          }
        }
      } catch (error) {
        console.error('Failed to load image data:', error);
        setIsImageLoading(false);
      } finally {
        // ÈáçÁΩÆÂä†ËΩΩÁä∂ÊÄÅÔºåÂÖÅËÆ∏‰∏ãÊ¨°Âä†ËΩΩ
        loadingRef.current = '';
      }
    };

    loadImageData();
  }, [imageId, categoryId, allCategories, categoriesLoading]);

  const handleDownload = async (format: 'png' | 'pdf') => {
    if (!image) return;

    try {
      setIsDownloading(prev => ({ ...prev, [format]: true }));
      
      // ÁîüÊàêÊñá‰ª∂Âêç
      const titleText = getLocalizedText(image.title, language) || 'image';
      const fileName = `coloring-page-${titleText.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 20)}-${image.id.slice(-8)}.${format}`;
      
      // Ê†πÊçÆÊ†ºÂºèÈÄâÊã©‰∏çÂêåÁöÑ‰∏ãËΩΩÊñπÂºè
      if (format === 'png') {
        await downloadImageByUrl(image.defaultUrl, fileName);
      } else {
        await downloadImageAsPdf(image.defaultUrl, fileName);
      }
    } catch (error) {
      console.error(`Download ${format} failed:`, error);
    } finally {
      setIsDownloading(prev => ({ ...prev, [format]: false }));
    }
  };

  // Ëé∑ÂèñÈù¢ÂåÖÂ±ëË∑ØÂæÑÔºàÂç≥‰ΩøÂõæÁâáËøòÂú®Âä†ËΩΩ‰πüÂèØ‰ª•ÊòæÁ§∫Âü∫Á°ÄÈù¢ÂåÖÂ±ëÔºâ
  const getBreadcrumbPathEarly = (): BreadcrumbItem[] => {
    // Âè™ÊúâÂΩìcategoryË¢´ËÆæÁΩÆÊó∂ÔºåÊâçÊòæÁ§∫ÂàÜÁ±ªÈù¢ÂåÖÂ±ë
    if (category) {
      // 4Â±ÇÈù¢ÂåÖÂ±ëÔºöHome > Coloring Pages Free > xxx category > ÂõæÁâáÂêçÂ≠ó
      const categoryName = getLocalizedText(category.displayName, language);
      const categoryPath = getCategoryNameById(category.categoryId);
      
      return [
        { label: t('breadcrumb.home'), path: '/' },
        { label: t('breadcrumb.categories'), path: '/categories' },
        { label: categoryName, path: `/categories/${categoryPath}` },
        { label: image ? getLocalizedText(image.title, language) || '' : '', current: true }
      ];
    } else {
      // ÈªòËÆ§2Â±ÇÈù¢ÂåÖÂ±ëÔºöHome > ÂõæÁâáÂêçÂ≠ó
      return [
        { label: t('breadcrumb.home'), path: '/' },
        { label: t('breadcrumb.categories'), path: '/categories' }
      ];
    }
  };

  const breadcrumbPath = getBreadcrumbPathEarly();

  // Â¶ÇÊûúÂõæÁâáÂä†ËΩΩÂ§±Ë¥•‰∏îÊ≤°ÊúâÊâæÂà∞ÂõæÁâá
  if (!isImageLoading && !image) {
    return (
      <Layout>
        <div className="w-full bg-[#F9FAFB] pb-16 md:pb-[120px]">
          {/* Breadcrumb - Âç≥‰ΩøÂá∫Èîô‰πüÊòæÁ§∫ */}
          <div className="container mx-auto px-4 py-6 lg:pt-10 lg:pb-8 max-w-[1200px]">
            <Breadcrumb items={[
              { label: t('breadcrumb.home'), path: '/' },
              { label: t('imageDetail.notFound.breadcrumb'), current: true }
            ]} />
          </div>
          
          <div className="container mx-auto px-4">
            <div className="flex flex-col items-center justify-center py-16">
              <div className="text-center">
                <div className="text-lg lg:text-xl text-[#161616] mb-4">{t('imageDetail.notFound.title')}</div>
                <Button onClick={() => navigate('/')} variant="gradient">
                  {t('imageDetail.notFound.goHome')}
                </Button>
              </div>
            </div>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <SEOHead
        title={image ? `${getLocalizedText(image.title, language)} - Free Coloring Page` : 'Coloring Page'}
        description={image ? `Download free printable ${getLocalizedText(image.title, language).toLowerCase()} coloring page. High-quality PDF and PNG formats available instantly.` : 'Download free printable coloring pages.'}
        keywords={image ? `${getLocalizedText(image.title, language).toLowerCase()} coloring page, free printable coloring page, ${getLocalizedText(image.title, language).toLowerCase()} coloring sheet` : 'coloring page, printable coloring page'}
        ogTitle={image ? `${getLocalizedText(image.title, language)} - Free Coloring Page` : 'Coloring Page'}
        ogDescription={image ? `Download free printable ${getLocalizedText(image.title, language).toLowerCase()} coloring page. High-quality PDF and PNG formats available instantly.` : 'Download free printable coloring pages.'}
        noIndex={true}
      />
      <div className="w-full bg-[#F9FAFB] pb-4 md:pb-20 relative">
        {/* Breadcrumb - ÂßãÁªàÊòæÁ§∫ */}
        <div className="container mx-auto px-4 py-6 lg:pt-10 lg:pb-8 max-w-[1380px]">
          <Breadcrumb items={breadcrumbPath} />
        </div>

        {/* Main Content */}
        <div className="container mx-auto px-4 max-w-[1380px]">
          {isImageLoading ? (
            /* Âä†ËΩΩÁä∂ÊÄÅ - ‰∏çÊòæÁ§∫‰ªª‰ΩïÊñáÊú¨ */
            <div className="flex justify-center items-center py-20 h-[1380px]">
              {/* Âä†ËΩΩÊó∂‰∏çÊòæÁ§∫‰ªª‰ΩïÂÜÖÂÆπ */}
            </div>
          ) : image ? (
            /* ÂõæÁâáÂÜÖÂÆπ */
            <div className="flex flex-col lg:flex-row gap-6 lg:gap-8 mb-12 lg:mb-20">
              {/* Left Side - Images */}
              <div ref={leftImagesRef} className={`flex gap-2 sm:gap-4 lg:gap-4 w-full lg:w-auto ${!(image.coloringUrl || image.colorUrl) ? 'justify-center' : ''}`}>
                {/* Black & White Image */}
                <div className={`${(image.coloringUrl || image.colorUrl) ? 'w-1/2' : 'w-full max-w-[320px]'} lg:max-w-[320px] flex items-start justify-center`}>
                  <img
                    src={image.defaultUrl}
                    alt={getLocalizedText(image.title, language)}
                    className="w-full max-w-full h-auto object-contain rounded-lg"
                  />
                </div>
                
                {/* Color Image */}
                {(image.coloringUrl || image.colorUrl) && (
                  <div className="w-1/2 lg:max-w-[320px] flex items-start justify-center">
                    <img
                      src={image.coloringUrl || image.colorUrl}
                      alt={`${getLocalizedText(image.title, language)} - Colored`}
                      className="w-full max-w-full h-auto object-contain rounded-lg"
                    />
                  </div>
                )}
              </div>

              {/* Right Side - Details */}
              <div className="flex-1 lg:max-w-[680px] flex flex-col">
                <div className="flex-1 space-y-6 lg:space-y-9">
                  {/* Title and Description */}
                  <div className="space-y-3 lg:space-y-4">
                    <h1 className="text-xl lg:text-2xl font-bold text-[#161616] capitalize leading-6 lg:leading-8">
                      {getLocalizedText(image.title, language)}
                    </h1>
                    <p className="text-sm text-[#6B7280] leading-5">
                      {getLocalizedText(image.description, language) || getLocalizedText(image.prompt, language)}
                    </p>
                  </div>

                  {/* Tags */}
                  {image.tags && image.tags.length > 0 && (
                    <div className="space-y-3 lg:space-y-4">
                      <h3 className="text-base font-medium text-black">{t('imageDetail.tags')}</h3>
                      <div className="flex flex-wrap gap-2">
                        {image.tags.map((tag: Tag) => (
                          <span
                            key={tag.tag_id}
                            className="px-3 py-2 bg-white border border-[#EDEEF0] rounded-2xl text-sm text-[#161616]"
                          >
                            {getLocalizedText(tag.display_name, language)}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                {/* Download Buttons - ÂìçÂ∫îÂºèÂ∏ÉÂ±Ä */}
                <div className="flex flex-col sm:flex-row gap-3 mt-6 sm:max-w-[480px]">
                  <Button
                    onClick={() => handleDownload('png')}
                    disabled={isDownloading.png}
                    variant="gradient"
                    className="flex-1 h-12 lg:h-[60px] text-base lg:text-xl font-bold"
                  >
                    <img src={downloadIcon} alt="Download" className="w-5 h-5 lg:w-7 lg:h-7 mr-2" />
                                      <span className="hidden sm:inline">{t('imageDetail.downloadPng')}</span>
                  <span className="sm:hidden">{t('imageDetail.png')}</span>
                  </Button>
                  
                  <Button
                    onClick={() => handleDownload('pdf')}
                    disabled={isDownloading.pdf}
                    variant="gradient"
                    className="flex-1 h-12 lg:h-[60px] text-base lg:text-xl font-bold"
                  >
                    <img src={downloadIcon} alt="Download" className="w-5 h-5 lg:w-7 lg:h-7 mr-2" />
                                      <span className="hidden sm:inline">{t('imageDetail.downloadPdf')}</span>
                  <span className="sm:hidden">{t('imageDetail.pdf')}</span>
                  </Button>
                </div>
              </div>
            </div>
          ) : null}

          {/* Detailed Description Sections - Âè™Âú®ÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÊòæÁ§∫ */}
          {!isImageLoading && image && (() => {
            const additionalInfo = parseAdditionalInfo(image.additionalInfo);
            
            if (!additionalInfo || !additionalInfo.trim()) {
              return null;
            }

            return (
              <div className="space-y-8 lg:space-y-12 mb-8 lg:mb-20">
                <section>
                  <div className="mx-auto text-left">
                    {(() => {
                      const descriptionText = additionalInfo;

                      // Êåâ <h2> Ê†áÁ≠æÂàÜÊÆµ
                      const sections = descriptionText.split(/<h2[^>]*>/).filter(section => section.trim());

                      if (sections.length <= 1) {
                        // Â¶ÇÊûúÊ≤°Êúâ h2 Ê†áÁ≠æÔºåÁõ¥Êé•ÊòæÁ§∫ÂéüÊñáÊú¨
                        const lines = descriptionText.split('\n').filter(line => line.trim());

                        return (
                          <div className="text-sm text-[#6B7280] leading-7">
                            {lines.map((line, index) => (
                              <p key={index} className="mb-3 last:mb-0">
                                {line.trim()}
                              </p>
                            ))}
                          </div>
                        );
                      }

                      // Â§ÑÁêÜÊúâ h2 Ê†áÁ≠æÁöÑÊÉÖÂÜµ
                      const allElements: Array<{ type: 'title' | 'content'; text: string; sectionIndex: number }> = [];

                      sections.forEach((section, sectionIndex) => {
                        const titleMatch = section.match(/^([^<]*)<\/h2>/);
                        const title = titleMatch ? titleMatch[1].trim() : '';
                        const content = section.replace(/^[^<]*<\/h2>/, '').trim();

                        if (title) {
                          allElements.push({ type: 'title', text: title, sectionIndex });
                        }

                        if (content) {
                          const contentLines = content.split('\n').filter(p => p.trim());
                          contentLines.forEach(line => {
                            allElements.push({ type: 'content', text: line.trim(), sectionIndex });
                          });
                        }
                      });

                      return (
                        <div>
                          {allElements.map((element, index) => (
                            <div key={`${element.sectionIndex}-${index}`} className="mb-3 lg:mb-4 last:mb-0">
                              {element.type === 'title' ? (
                                <h3 className="text-[#161616] text-lg lg:text-xl font-semibold mb-3 lg:mb-4">
                                  {element.text}
                                </h3>
                              ) : (
                                <p className="text-sm text-[#6B7280] leading-7">
                                  {element.text}
                                </p>
                              )}
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                  </div>
                </section>
              </div>
            );
          })()}

          {/* You Might Also Like - Áã¨Á´ãÊòæÁ§∫Áõ∏ÂÖ≥ÂõæÁâáÂä†ËΩΩÁä∂ÊÄÅ */}
          <section>
            <h2 className="text-center text-[#161616] text-2xl lg:text-3xl xl:text-[46px] font-bold capitalize mb-8 lg:mb-12 leading-relaxed lg:leading-[1.6] px-4">
              {t('imageDetail.relatedImages')}
            </h2>
            
            {/* Related Images Grid */}
            <div className="mb-8 lg:mb-20">
              {isRelatedImagesLoading ? (
                <div className="flex justify-center items-center py-12">
                  {/* Âä†ËΩΩÊó∂‰∏çÊòæÁ§∫‰ªª‰ΩïÂÜÖÂÆπ */}
                </div>
              ) : relatedImages.length > 0 ? (
                <MasonryGrid 
                  images={relatedImages}
                  isLoading={false}
                  onImageClick={(image) => {
                    // ÂØºËà™Âà∞ÂõæÁâáËØ¶ÊÉÖÈ°µÔºå‰ΩøÁî®SEOÂèãÂ•ΩÁöÑÂõæÁâáË∑ØÂæÑ
                    const imagePath = getImageNameById(image.id);
                    
                    // Â¶ÇÊûúÂΩìÂâçÂú®ÂàÜÁ±ªÈ°µÈù¢ÁªìÊûÑ‰∏≠Ôºå‰øùÊåÅÂú®Âêå‰∏ÄÂàÜÁ±ªÂÜÖË∑≥ËΩ¨
                    if (categoryId) {
                      navigateWithLanguage(navigate, `/categories/${categoryId}/${imagePath}`);
                    } else {
                      // Âê¶Âàô‰ΩøÁî®‰º†ÁªüÁöÑÂõæÁâáËØ¶ÊÉÖÈ°µË∑ØÂæÑ
                      navigateWithLanguage(navigate, `/image/${imagePath}`);
                    }
                  }}
                />
              ) : (
                <div className="flex justify-center items-center py-12">
                  <div className="text-sm text-[#6B7280]">{t('imageDetail.noRelatedImages')}</div>
                </div>
              )}
            </div>
          </section>
        </div>
      </div>
    </Layout>
  );
};

export default ImageDetailPage; 